let bidderIds = [];
let combinedData = [];
let dataC = [];
let dataX = [];

function googleClientLoaded() {
    gapi.load('client', function() {
        gapi.client.init({
            apiKey: 'YAIzaSyAOeuLYMYBkFeGyzI_mJQo1tFAjTf8UL9w',
            clientId: '664374659896-m0a5r65ev0kfldmaberdmb7nf6llucae.apps.googleusercontent.com',
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            scope: 'https://www.googleapis.com/auth/spreadsheets.readonly'
        }).then(function() {
            gapi.auth2.getAuthInstance().signIn().then(function() {
                fetchData();
            }, function(error) {
                console.error('Sign-in error:', error);
                alert('Failed to sign in. Please try again.');
            });
        }

        // Load first dropdown from Analysis2!B7:B
        function loadDropdown1() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Analysis2!B7:B'
            }).then(response => {
                const values = response.result.values || [];
                const dropdown1 = document.getElementById('dropdown1');
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value[0];
                    option.text = value[0];
                    dropdown1.appendChild(option);
                });
                dropdown1.addEventListener('change', loadDropdown2);
            });
        }

        // Load second dropdown based on Flow and Flow 1
        function loadDropdown2() {
            const selected1 = document.getElementById('dropdown1').value;
            const dropdown2 = document.getElementById('dropdown2');
            dropdown2.innerHTML = '<option value="">Select an option</option>';

            ['Flow', 'Flow 1'].forEach(sheet => {
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${sheet}!A:L`
                }).then(response => {
                    const values = response.result.values || [];
                    const filtered = values.filter(row => 
                        row[11] === 'Closed' && row[6] === selected1
                    ).map(row => row[3]); // D:D is index 3, L:L is 11, G:G is 6

                    if (filtered.length > 0) {
                        filtered.forEach(value => {
                            const option = document.createElement('option');
                            option.value = value;
                            option.text = value;
                            dropdown2.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = 'N/A';
                        option.text = 'N/A';
                        dropdown2.appendChild(option);
                    }
                });
            });

            dropdown2.addEventListener('change', updateResults);
        }

        // Update results in 3rd and 4th rows
        function updateResults() {
            const selected2 = document.getElementById('dropdown2').value;
            const resultBox = document.getElementById('resultBox');
            const box4a = document.getElementById('box4a');
            const box4b = document.getElementById('box4b');

            // 3rd row: Filter Data!X:X where C:C matches selected2
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Data!A:X'
            }).then(response => {
                const values = response.result.values || [];
                const filtered = values.find(row => row[2] === selected2); // C:C is index 2
                resultBox.textContent = filtered ? filtered[23] : 'N/A'; // X:X is index 23

                // 4th row, left box: Percentage from Analysis2!B:C
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Analysis2!B:C'
                }).then(response => {
                    const values = response.result.values || [];
                    const match = values.find(row => row[0] === selected2);
                    const percentage = match ? parseFloat(match[1]).toFixed(2) : 'N/A';
                    box4a.textContent = percentage !== 'N/A' ? `${percentage}%` : 'N/A';

                    // 4th row, right box: Text based on percentage
                    if (percentage === '0.00') {
                        box4b.textContent = '-- Won';
                    } else if (percentage !== 'N/A') {
                        box4b.textContent = 'higher than the lowest bid';
                    } else {
                        box4b.textContent = 'N/A';
                    }
                });
            });
        }

        loadGapi();
    </script>
</body>
</html>